{% assign related_posts = site.posts | where: "hidden", false %}
{% assign shared_tag_posts = "" %}
{% for post in related_posts %}
  {% if post.id != page.id %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign shared_tag_posts = shared_tag_posts | append: post.url | append: "," %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
{% assign shared_tag_posts_array = shared_tag_posts | split: "," | uniq %}
<div class="page__related">
  {% include before-related.html %}
  <h2 class="page__related-title">{{ site.data.ui-text[site.locale].related_label | default: "You May Also Enjoy" }}</h2>
  <div class="grid__wrapper">
    {% for url in shared_tag_posts_array limit:4 %}
      {% assign post = site.posts | where: "url", url | first %}
      {% include archive-single.html type="grid" %}
    {% endfor %}
  </div>
</div>

